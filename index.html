<!DOCTYPE html>
<html lang="en" class="dark"> 
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSFA Guardian App</title>
    
    <!-- **UPDATED Favicon: Combined Logo (Book + Focus + Star)** -->
    <!-- Represents Study, Focus, and Success combined with a modern feel -->
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='[http://www.w3.org/2000/svg](http://www.w3.org/2000/svg)' viewBox='0 0 24 24' fill='none'%3E%3C!-- Base (Book) --%3E%3Cpath d='M2 6V20C2 21.1046 2.89543 22 4 22H20C21.1046 22 22 21.1046 22 20V6C22 4.89543 21.1046 4 20 4H4C2.89543 4 2 4.89543 2 6Z' fill='%236EE7B7' opacity='0.7'/%3E%3C!-- Focus Ring (Magnifier) --%3E%3Ccircle cx='12' cy='12' r='4.5' stroke='%233B82F6' stroke-width='1.5'/%3E%3Cpath d='M15 15L18 18' stroke='%233B82F6' stroke-width='1.5' stroke-linecap='round'/%3E%3C!-- Success Star (Top) --%3E%3Cpath d='M12 7L13.8861 10.8861L18 12L13.8861 13.8861L12 18L10.1139 13.8861L6 12L10.1139 10.1139L12 7Z' fill='%23FBBF24' stroke='%23FBBF24' stroke-width='0.5'/%3E%3C/svg%3E" type="image/svg+xml">
    
    <!-- Load Tailwind CSS -->
    <script src="[https://cdn.tailwindcss.com](https://cdn.tailwindcss.com)"></script>
    <!-- Load React and ReactDOM -->
    <script src="[https://unpkg.com/react@18/umd/react.development.js](https://unpkg.com/react@18/umd/react.development.js)"></script>
    <script src="[https://unpkg.com/@babel/standalone/babel.min.js](https://unpkg.com/@babel/standalone/babel.min.js)"></script>
    <script src="[https://unpkg.com/react-dom@18/umd/react-dom.development.js](https://unpkg.com/react-dom@18/umd/react-dom.development.js)"></script>
    
    <!-- **CRITICAL FIX: Load Font Awesome for reliable icons** -->
    <link rel="stylesheet" href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css)" />
    
    <style>
        /* Custom font for better UI */
        @import url('[https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap](https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap)');
        
        html.dark body {
            background-color: #0d1117; 
        }
        
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6; 
        }
        #root {
            width: 100%;
        }
        /* Custom Progress Bar Style */
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            transition: width 0.5s ease-in-out;
        }
        /* Custom Button Hover Effect */
        .cmd-btn:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // --- CONFIGURATION CONSTANTS ---
        const BLUETOOTH_SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb'; 
        const BLUETOOTH_CHARACTERISTIC_UUID = '0000ffe1-0000-1000-8000-00805f9b34fb';
        const DAILY_GOAL_MINUTES = 60; 

        // --- Custom Icon Component using Font Awesome ---
        const Icon = ({ className, iconClass }) => {
            return <i className={`${className} ${iconClass}`}></i>;
        };
        
        // Mappings for the study states sent by Arduino
        const STATUS_ICONS = {
            STUDYING: { iconClass: 'fa-solid fa-lightbulb', color: 'text-green-400', label: 'Focused Studying' },
            DISTRACTED: { iconClass: 'fa-solid fa-triangle-exclamation', color: 'text-red-400', label: 'Distracted! Refocus' },
            IDLE: { iconClass: 'fa-solid fa-mug-hot', color: 'text-yellow-400', label: 'Idle / Break Time' },
            OBSERVING: { iconClass: 'fa-solid fa-magnifying-glass', color: 'text-blue-400', label: 'System Observing' },
            STOPPED: { iconClass: 'fa-solid fa-stop-circle', color: 'text-gray-500', label: 'Stopped / Ready' },
            DEFAULT: { iconClass: 'fa-solid fa-plug-circle-xmark', color: 'text-gray-600', label: 'Disconnected' }
        };

        // --- Custom Modal Component (Same as before) ---
        const CustomModal = ({ isOpen, title, message, onClose, onConfirm }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm">
                    <div className="bg-gray-800 p-6 rounded-xl shadow-2xl w-11/12 max-w-sm transform transition-all duration-300 scale-100 border border-gray-700">
                        <h3 className="text-xl font-bold mb-3 text-white">{title}</h3>
                        <p className="text-sm text-gray-400 mb-6">{message}</p>
                        <div className="flex justify-end space-x-3">
                            {onConfirm && (
                                <button
                                    onClick={onConfirm}
                                    className="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150"
                                >
                                    নিশ্চিত করুন (Confirm)
                                </button>
                            )}
                            <button
                                onClick={onClose}
                                className={`px-4 py-2 ${onConfirm ? 'bg-gray-700 text-white hover:bg-gray-600' : 'bg-blue-600 text-white hover:bg-blue-700'} font-semibold rounded-lg transition duration-150`}
                            >
                                {onConfirm ? 'বাতিল (Cancel)' : 'বন্ধ করুন (Close)'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Utility Functions for Bluetooth Communication (Same as before) ---
        const connectBluetooth = async () => {
            if (!navigator.bluetooth) {
                throw new Error("Bluetooth is not supported in this browser. Use Chrome/Edge on Desktop/Android.");
            }
            try {
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [BLUETOOTH_SERVICE_UUID] }],
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(BLUETOOTH_SERVICE_UUID);
                const characteristic = await service.getCharacteristic(BLUETOOTH_CHARACTERISTIC_UUID);
                return { device, server, characteristic };
            } catch (error) {
                console.error("Bluetooth Connection Error:", error);
                if (error.message.includes("User cancelled")) {
                    throw new Error("সংযোগ বাতিল করা হয়েছে। দয়া করে আবার চেষ্টা করুন।");
                }
                throw new Error("Arduino-এর সাথে সংযোগ করা যায়নি। নিশ্চিত করুন যে Bluetooth চালু আছে এবং Arduino চালু আছে।");
            }
        };

        const sendCommand = async (characteristic, command) => {
            if (!characteristic) return console.error("Bluetooth Characteristic not available.");
            try {
                const value = new TextEncoder().encode(`${command}\n`); 
                await characteristic.writeValue(value);
                console.log("Command sent:", command);
            } catch (error) {
                console.error("Error sending command:", error);
            }
        };

        const parseStatus = (data) => {
            const text = new TextDecoder().decode(data).trim();
            if (!text.startsWith("STATUS|")) return null;

            const parts = text.split('|').slice(1);
            const status = {};
            parts.forEach(part => {
                const [key, value] = part.split('=');
                if (key && value) {
                    status[key.trim()] = value.trim();
                }
            });

            return {
                state: status.state || 'STOPPED',
                minutesToday: parseInt(status.minutesToday || '0'),
                points: parseInt(status.points || '0'),
                silentMode: status.silentMode === '1',
                raw: text
            };
        };


        // --- MAIN REACT COMPONENT ---
        function App() {
            const [bluetoothStatus, setBluetoothStatus] = useState('Disconnected');
            const [statusData, setStatusData] = useState({ state: 'DEFAULT', minutesToday: 0, points: 0, silentMode: false, raw: "Arduino থেকে স্ট্যাটাস ডেটার জন্য অপেক্ষা করছে..." });
            const [btCharacteristic, setBtCharacteristic] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalContent, setModalContent] = useState({});

            const handleConnect = useCallback(async () => {
                setBluetoothStatus('Connecting...');
                try {
                    const result = await connectBluetooth();
                    setBtCharacteristic(result.characteristic);
                    setBluetoothStatus('Connected');
                    
                    result.characteristic.startNotifications();
                    result.characteristic.addEventListener('characteristicvaluechanged', (event) => {
                        const data = event.target.value;
                        const parsed = parseStatus(data);
                        if (parsed) {
                            console.log("Received data:", parsed);
                            setStatusData(parsed);
                        }
                    });

                    result.server.device.addEventListener('gattserverdisconnected', () => {
                        setBluetoothStatus('Disconnected');
                        setBtCharacteristic(null);
                        setStatusData({ state: 'DEFAULT', minutesToday: 0, points: 0, silentMode: false, raw: "সংযোগ বিচ্ছিন্ন হয়েছে।" });
                    });

                    sendCommand(result.characteristic, "status");

                } catch (error) {
                    setBluetoothStatus('Disconnected');
                    setModalContent({ 
                        title: "সংযোগ ব্যর্থ (Connection Failed)", 
                        message: error.message.includes("Bluetooth") 
                            ? "এই ব্রাউজারে ব্লুটুথ সমর্থিত নয় (Android/Chrome ব্যবহার করুন)।" 
                            : error.message, 
                        onClose: () => setIsModalOpen(false) 
                    });
                    setIsModalOpen(true);
                }
            }, []);

            const handleSendCommand = useCallback((cmd) => {
                if (bluetoothStatus !== 'Connected' || !btCharacteristic) {
                    setModalContent({ 
                        title: "সংযোগ বিচ্ছিন্ন (Disconnected)", 
                        message: "দয়া করে আগে SSFA Arduino-এর সাথে সংযোগ করুন।",
                        onClose: () => setIsModalOpen(false) 
                    });
                    setIsModalOpen(true);
                    return;
                }
                
                if (cmd === 'reset') {
                    setModalContent({ 
                        title: "রিসেট নিশ্চিত করুন (Confirm Reset)", 
                        message: "আপনি কি আজকের স্টাডি ডেটা এবং পয়েন্ট রিসেট করতে চান? এই প্রক্রিয়াটি অপরিবর্তনীয়।", 
                        onConfirm: () => {
                            sendCommand(btCharacteristic, "reset");
                            setIsModalOpen(false);
                            setStatusData(prev => ({ ...prev, minutesToday: 0, points: 0 }));
                        },
                        onClose: () => setIsModalOpen(false)
                    });
                    setIsModalOpen(true);
                    return;
                }
                
                sendCommand(btCharacteristic, cmd);
                
                if (cmd === 'silent') {
                    setStatusData(prev => ({ ...prev, silentMode: !prev.silentMode })); 
                }
                
            }, [bluetoothStatus, btCharacteristic]);

            const currentStatus = useMemo(() => STATUS_ICONS[statusData.state] || STATUS_ICONS.DEFAULT, [statusData.state]);

            const formatMinutes = (totalMinutes) => {
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours}h ${minutes}m`;
            };
            
            // Calculate progress for the goal
            const progressPercentage = Math.min(100, (statusData.minutesToday / DAILY_GOAL_MINUTES) * 100);


            // UI Components (Cards and Buttons)
            const StatCard = ({ title, value, iconClass, iconColor = 'text-blue-400' }) => (
                <div className="bg-gray-800 p-4 rounded-xl shadow-lg flex items-center space-x-4 transition duration-300 hover:shadow-xl border border-gray-700">
                    <div className={`p-3 rounded-full ${iconColor} bg-opacity-20`}>
                        <Icon iconClass={iconClass} className={`${iconColor} text-2xl w-8 h-8 flex items-center justify-center`} />
                    </div>
                    <div>
                        <p className="text-xs font-medium text-gray-400 uppercase">{title}</p>
                        <p className="text-2xl font-bold text-white">{value}</p>
                    </div>
                </div>
            );

            const CommandButton = ({ label, iconClass, onClick, bgColor, disabled = false }) => (
                <button
                    onClick={onClick}
                    disabled={disabled}
                    className={`cmd-btn flex flex-col items-center justify-center p-3 sm:p-4 rounded-xl shadow-md transition duration-200 ${bgColor} text-white font-semibold transform hover:scale-[1.03] active:scale-[0.98] disabled:opacity-40 disabled:cursor-not-allowed h-24`}
                >
                    <Icon iconClass={iconClass} className="mb-1 text-3xl" />
                    <span className="text-xs font-medium text-center">{label}</span>
                </button>
            );

            // Main Render
            return (
                <div className="app-container w-full mx-auto max-w-screen-md font-sans p-4 sm:p-6 dark:bg-gray-900">
                    
                    <header className="mb-6">
                        <h1 className="text-3xl font-extrabold text-white mb-1">
                            SSFA Guardian App
                        </h1>
                        <p className="text-sm text-gray-400">
                            রিমোট মনিটরিং ইন্টারফেস (Pure Bluetooth)
                        </p>
                    </header>

                    {/* Connection Status Card */}
                    <div className="mb-6 bg-gray-800 p-4 rounded-xl shadow-xl border border-gray-700">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center space-x-3">
                                <span className={`h-3 w-3 rounded-full ${bluetoothStatus === 'Connected' ? 'bg-green-500 animate-pulse' : bluetoothStatus === 'Connecting...' ? 'bg-yellow-500' : 'bg-red-500'}`}></span>
                                <p className="text-sm font-semibold text-gray-300">
                                    Bluetooth স্ট্যাটাস: <span className="font-bold text-white">{bluetoothStatus}</span>
                                </p>
                            </div>
                            <button
                                onClick={handleConnect}
                                disabled={bluetoothStatus === 'Connected' || bluetoothStatus === 'Connecting...'}
                                className="px-4 py-2 text-xs font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150 disabled:bg-gray-700 disabled:shadow-none"
                            >
                                {bluetoothStatus === 'Connecting...' ? 'সংযোগ হচ্ছে...' : 'Arduino-এর সাথে সংযোগ'}
                            </button>
                        </div>
                    </div>

                    {/* Live Status and Stats */}
                    <div className="bg-gray-800 p-6 rounded-xl shadow-2xl mb-6 border border-gray-700">
                        <div className="flex items-center space-x-4 mb-4">
                            <Icon iconClass={currentStatus.iconClass} className={`text-4xl ${currentStatus.color} w-12 h-12 flex items-center justify-center`} />
                            <div>
                                <p className="text-xs text-gray-400 uppercase">বর্তমান স্ট্যাটাস</p>
                                <p className={`text-2xl font-extrabold ${currentStatus.color}`}>{currentStatus.label}</p>
                            </div>
                        </div>
                        
                        <hr className="border-gray-700 my-4" />
                        
                        {/* Daily Goal Progress Bar */}
                        <div className="mb-6">
                            <div className="flex justify-between items-center text-sm mb-1">
                                <p className="font-medium text-white">দৈনিক লক্ষ্যের দিকে ফোকাস</p>
                                <p className="text-gray-400">{Math.round(progressPercentage)}% সম্পন্ন ({formatMinutes(statusData.minutesToday)} / {DAILY_GOAL_MINUTES}m)</p>
                            </div>
                            <div className="bg-gray-700 rounded-lg progress-bar">
                                <div 
                                    className={`progress-bar ${progressPercentage >= 100 ? 'bg-green-500' : 'bg-pink-500'}`}
                                    style={{ width: `${progressPercentage}%` }}
                                ></div>
                            </div>
                            {progressPercentage >= 100 && (
                                <p className="text-xs text-green-400 mt-2 font-semibold flex items-center">
                                    <Icon iconClass="fa-solid fa-circle-check" className="mr-1 text-sm" />
                                    আজকের ফোকাস লক্ষ্য অর্জন করা হয়েছে!
                                </p>
                            )}
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                            <StatCard 
                                title="মোট স্টাডি টাইম" 
                                value={formatMinutes(statusData.minutesToday)} 
                                iconClass="fa-solid fa-clock"
                                iconColor="text-pink-400"
                            />
                            <StatCard 
                                title="ফোকাস পয়েন্ট" 
                                value={statusData.points} 
                                iconClass="fa-solid fa-star"
                                iconColor="text-yellow-400"
                            />
                        </div>
                    </div>
                    
                    {/* Remote Commands */}
                    <h2 className="text-xl font-bold text-white mb-4">রিমোট কমান্ডস</h2>

                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <CommandButton
                            label={statusData.silentMode ? 'সাউন্ড চালু করুন' : 'সাইলেন্ট মোড'}
                            iconClass={statusData.silentMode ? 'fa-solid fa-volume-high' : 'fa-solid fa-volume-off'}
                            onClick={() => handleSendCommand('silent')}
                            bgColor={statusData.silentMode ? 'bg-indigo-600 hover:bg-indigo-700' : 'bg-gray-600 hover:bg-gray-700'}
                            disabled={bluetoothStatus !== 'Connected'}
                        />
                        <CommandButton
                            label="মোটিভেশন পাঠান"
                            iconClass="fa-solid fa-bell-concierge"
                            onClick={() => handleSendCommand('motivation')}
                            bgColor="bg-green-600 hover:bg-green-700"
                            disabled={bluetoothStatus !== 'Connected'}
                        />
                        <CommandButton
                            label="ডেটা রিসেট"
                            iconClass="fa-solid fa-arrows-rotate"
                            onClick={() => handleSendCommand('reset')}
                            bgColor="bg-red-600 hover:bg-red-700"
                            disabled={bluetoothStatus !== 'Connected'}
                        />
                            <CommandButton
                            label="স্ট্যাটাস রিফ্রেশ"
                            iconClass="fa-solid fa-arrows-rotate"
                            onClick={() => handleSendCommand('status')}
                            bgColor="bg-blue-600 hover:bg-blue-700"
                            disabled={bluetoothStatus !== 'Connected'}
                        />
                    </div>

                    {/* Debug/Info Section */}
                    <h2 className="text-xl font-bold text-white mt-8 mb-4">ডিবাগ লগ</h2>
                    <div className="bg-gray-800 p-4 rounded-xl text-xs overflow-x-auto text-gray-400 border border-gray-700">
                        <pre className="whitespace-pre-wrap break-words">{statusData.raw}</pre>
                    </div>

                    {/* Custom Modal for Alerts */}
                    <CustomModal 
                        isOpen={isModalOpen}
                        title={modalContent.title}
                        message={modalContent.message}
                        onClose={() => setIsModalOpen(false)}
                        onConfirm={modalContent.onConfirm}
                    />
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
