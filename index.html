<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SSFA Guardian App</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Load Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <style>
        /* Custom font for better UI */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f3f4f6; /* Light gray background */
        }
        /* CRITICAL FIX: Ensure the root element takes the full available width */
        #root {
            width: 100%;
        }
        /* App container background styling */
        .app-container {
             background-color: #f3f4f6; 
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        
        // --- CONFIGURATION CONSTANTS (Matching Arduino Logic) ---
        const BLUETOOTH_SERVICE_UUID = '0000ffe0-0000-1000-8000-00805f9b34fb'; 
        const BLUETOOTH_CHARACTERISTIC_UUID = '0000ffe1-0000-1000-8000-00805f9b34fb';

        // Mappings for the study states sent by Arduino
        const STATUS_ICONS = {
            STUDYING: { icon: 'üí°', color: 'text-green-500', label: 'Focused Studying' },
            DISTRACTED: { icon: 'üö®', color: 'text-red-500', label: 'Distracted! Refocus' },
            IDLE: { icon: '‚òï', color: 'text-yellow-500', label: 'Idle / Break Time' },
            OBSERVING: { icon: 'üîé', color: 'text-blue-500', label: 'System Observing' },
            STOPPED: { icon: 'üõë', color: 'text-gray-400', label: 'Stopped / Ready' },
            DEFAULT: { icon: 'üîå', color: 'text-gray-400', label: 'Disconnected' }
        };

        // --- Custom Modal Component (Instead of alert/confirm) ---
        const CustomModal = ({ isOpen, title, message, onClose, onConfirm }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm">
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl w-11/12 max-w-sm transform transition-all duration-300 scale-100">
                        <h3 className="text-xl font-bold mb-3 text-gray-900 dark:text-white">{title}</h3>
                        <p className="text-sm text-gray-600 dark:text-gray-300 mb-6">{message}</p>
                        <div className="flex justify-end space-x-3">
                            {onConfirm && (
                                <button
                                    onClick={onConfirm}
                                    className="px-4 py-2 bg-red-600 text-white font-semibold rounded-lg hover:bg-red-700 transition duration-150"
                                >
                                    ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® (Confirm)
                                </button>
                            )}
                            <button
                                onClick={onClose}
                                className={`px-4 py-2 ${onConfirm ? 'bg-gray-200 text-gray-800 hover:bg-gray-300 dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600' : 'bg-blue-600 text-white hover:bg-blue-700'} font-semibold rounded-lg transition duration-150`}
                            >
                                {onConfirm ? '‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ (Cancel)' : '‡¶¨‡¶®‡ßç‡¶ß ‡¶ï‡¶∞‡ßÅ‡¶® (Close)'}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Utility Functions for Bluetooth Communication ---
        const connectBluetooth = async () => {
            if (!navigator.bluetooth) {
                throw new Error("Bluetooth is not supported in this browser. Use Chrome/Edge on Desktop/Android.");
            }
            try {
                // Request the device using the service UUID
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [BLUETOOTH_SERVICE_UUID] }],
                });
                const server = await device.gatt.connect();
                const service = await server.getPrimaryService(BLUETOOTH_SERVICE_UUID);
                const characteristic = await service.getCharacteristic(BLUETOOTH_CHARACTERISTIC_UUID);
                return { device, server, characteristic };
            } catch (error) {
                console.error("Bluetooth Connection Error:", error);
                // Throw specific error messages based on common failures
                if (error.message.includes("User cancelled")) {
                    throw new Error("‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                }
                throw new Error("Arduino-‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø‡•§ ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ø‡ßá Bluetooth ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶Ü‡¶õ‡ßá ‡¶è‡¶¨‡¶Ç Arduino ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶Ü‡¶õ‡ßá‡•§");
            }
        };

        const sendCommand = async (characteristic, command) => {
            if (!characteristic) return console.error("Bluetooth Characteristic not available.");
            try {
                // Commands are sent as ASCII strings followed by a newline character
                const value = new TextEncoder().encode(`${command}\n`); 
                await characteristic.writeValue(value);
                console.log("Command sent:", command);
            } catch (error) {
                console.error("Error sending command:", error);
            }
        };

        const parseStatus = (data) => {
            // Expected format: STATUS|state=STUDYING|minutesToday=45|points=15|silentMode=1
            const text = new TextDecoder().decode(data).trim();
            if (!text.startsWith("STATUS|")) return null;

            const parts = text.split('|').slice(1);
            const status = {};
            parts.forEach(part => {
                const [key, value] = part.split('=');
                if (key && value) {
                    status[key.trim()] = value.trim();
                }
            });

            return {
                state: status.state || 'STOPPED',
                minutesToday: parseInt(status.minutesToday || '0'),
                points: parseInt(status.points || '0'),
                silentMode: status.silentMode === '1',
                raw: text
            };
        };


        // --- MAIN REACT COMPONENT ---
        function App() {
            const [bluetoothStatus, setBluetoothStatus] = useState('Disconnected');
            const [statusData, setStatusData] = useState({ state: 'DEFAULT', minutesToday: 0, points: 0, silentMode: false, raw: "Arduino ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶°‡ßá‡¶ü‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡¶õ‡ßá..." });
            const [btCharacteristic, setBtCharacteristic] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalContent, setModalContent] = useState({});

            // Handler for Bluetooth Connection
            const handleConnect = useCallback(async () => {
                setBluetoothStatus('Connecting...');
                try {
                    const result = await connectBluetooth();
                    setBtCharacteristic(result.characteristic);
                    setBluetoothStatus('Connected');
                    
                    // 1. Start listening for data from Arduino
                    result.characteristic.startNotifications();
                    result.characteristic.addEventListener('characteristicvaluechanged', (event) => {
                        const data = event.target.value;
                        const parsed = parseStatus(data);
                        if (parsed) {
                            console.log("Received data:", parsed);
                            setStatusData(parsed);
                        }
                    });

                    // 2. Handle unexpected disconnection
                    result.server.device.addEventListener('gattserverdisconnected', () => {
                        setBluetoothStatus('Disconnected');
                        setBtCharacteristic(null);
                        setStatusData({ state: 'DEFAULT', minutesToday: 0, points: 0, silentMode: false, raw: "‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‡¶®‡ßç‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§" });
                        console.log("Device disconnected.");
                    });

                    // 3. Request initial status
                    sendCommand(result.characteristic, "status");

                } catch (error) {
                    setBluetoothStatus('Disconnected');
                    setModalContent({ 
                        title: "‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡ßç‡¶Ø‡¶∞‡ßç‡¶• (Connection Failed)", 
                        message: error.message.includes("Bluetooth") 
                            ? "‡¶è‡¶á ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá ‡¶¨‡ßç‡¶≤‡ßÅ‡¶ü‡ßÅ‡¶• ‡¶∏‡¶Æ‡¶∞‡ßç‡¶•‡¶ø‡¶§ ‡¶®‡ßü (Android/Chrome ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®)‡•§" 
                            : error.message, // Display the specific connection error
                        onClose: () => setIsModalOpen(false) 
                    });
                    setIsModalOpen(true);
                }
            }, []);

            // Handler for sending commands (Silent, Motivation, Reset)
            const handleSendCommand = useCallback((cmd) => {
                if (bluetoothStatus !== 'Connected' || !btCharacteristic) {
                    setModalContent({ 
                        title: "‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶¨‡¶ø‡¶ö‡ßç‡¶õ‡¶ø‡¶®‡ßç‡¶® (Disconnected)", 
                        message: "‡¶¶‡ßü‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶ó‡ßá SSFA Arduino-‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®‡•§",
                        onClose: () => setIsModalOpen(false) 
                    });
                    setIsModalOpen(true);
                    return;
                }
                
                if (cmd === 'reset') {
                    // Show confirmation modal for reset command
                    setModalContent({ 
                        title: "‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® (Confirm Reset)", 
                        message: "‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶°‡¶ø ‡¶°‡ßá‡¶ü‡¶æ ‡¶è‡¶¨‡¶Ç ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®? ‡¶è‡¶á ‡¶™‡ßç‡¶∞‡¶ï‡ßç‡¶∞‡¶ø‡¶Ø‡¶º‡¶æ‡¶ü‡¶ø ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßÄ‡¶Ø‡¶º‡•§", 
                        onConfirm: () => {
                            sendCommand(btCharacteristic, "reset");
                            setIsModalOpen(false);
                            // Optimistically update UI after confirming reset
                            setStatusData(prev => ({ ...prev, minutesToday: 0, points: 0 }));
                        },
                        onClose: () => setIsModalOpen(false)
                    });
                    setIsModalOpen(true);
                    return;
                }
                
                // Send command for 'silent', 'motivation', and 'status'
                sendCommand(btCharacteristic, cmd);
                
                // Optimistically update silent mode UI immediately
                if (cmd === 'silent') {
                    setStatusData(prev => ({ ...prev, silentMode: !prev.silentMode })); 
                }
                
            }, [bluetoothStatus, btCharacteristic]);

            // Display Calculations
            const currentStatus = useMemo(() => STATUS_ICONS[statusData.state] || STATUS_ICONS.DEFAULT, [statusData.state]);

            const formatMinutes = (totalMinutes) => {
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                return `${hours}h ${minutes}m`;
            };

            // UI Components (Cards and Buttons)
            const StatCard = ({ title, value, icon, iconColor = 'text-blue-500' }) => (
                <div className="bg-white dark:bg-gray-700 p-4 rounded-xl shadow-lg flex items-center space-x-4 transition duration-300 hover:shadow-xl border-t-4 border-gray-300 dark:border-gray-600">
                    <div className={`p-3 rounded-full ${iconColor} bg-opacity-20`}>
                        <span className="text-2xl">{icon}</span>
                    </div>
                    <div>
                        <p className="text-xs font-medium text-gray-500 dark:text-gray-400 uppercase">{title}</p>
                        <p className="text-2xl font-bold text-gray-900 dark:text-white">{value}</p>
                    </div>
                </div>
            );

            const CommandButton = ({ label, icon, onClick, bgColor, disabled = false }) => (
                <button
                    onClick={onClick}
                    disabled={disabled}
                    className={`flex flex-col items-center justify-center p-3 sm:p-4 rounded-xl shadow-lg transition duration-150 ${bgColor} text-white font-semibold transform hover:scale-[1.05] active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed h-24`}
                >
                    <span className="text-3xl mb-1">{icon}</span>
                    <span className="text-xs font-medium text-center">{label}</span>
                </button>
            );

            // Main Render
            return (
                <div className="app-container w-full mx-auto max-w-screen-md font-sans p-4 sm:p-6">
                    
                    <header className="mb-6">
                        <h1 className="text-3xl font-extrabold text-gray-900 dark:text-white mb-2 text-shadow">
                            SSFA Guardian
                        </h1>
                        <p className="text-sm text-gray-600 dark:text-gray-400">
                            ‡¶∞‡¶ø‡¶Æ‡ßã‡¶ü ‡¶Æ‡¶®‡¶ø‡¶ü‡¶∞‡¶ø‡¶Ç ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶´‡ßá‡¶∏ (Pure Bluetooth)
                        </p>
                    </header>

                    {/* Connection Status Card */}
                    <div className="mb-6 bg-white dark:bg-gray-800 p-4 rounded-xl shadow-lg border-b-4 border-blue-500">
                        <div className="flex justify-between items-center">
                            <div className="flex items-center space-x-3">
                                <span className={`h-3 w-3 rounded-full ${bluetoothStatus === 'Connected' ? 'bg-green-500 animate-pulse' : bluetoothStatus === 'Connecting...' ? 'bg-yellow-500' : 'bg-red-500'}`}></span>
                                <p className="text-sm font-semibold text-gray-700 dark:text-gray-300">
                                    Bluetooth ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏: <span className="font-bold">{bluetoothStatus}</span>
                                </p>
                            </div>
                            <button
                                onClick={handleConnect}
                                disabled={bluetoothStatus === 'Connected' || bluetoothStatus === 'Connecting...'}
                                className="px-4 py-2 text-xs font-bold text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition duration-150 disabled:bg-gray-400 disabled:shadow-none"
                            >
                                {bluetoothStatus === 'Connecting...' ? '‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó ‡¶π‡¶ö‡ßç‡¶õ‡ßá...' : 'Arduino-‡¶è‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶∏‡¶Ç‡¶Ø‡ßã‡¶ó'}
                            </button>
                        </div>
                    </div>

                    {/* Live Status and Stats */}
                    <div className="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-2xl mb-6">
                        <div className="flex items-center space-x-4 mb-4">
                            <span className={`text-5xl ${currentStatus.color}`}>{currentStatus.icon}</span>
                            <div>
                                <p className="text-xs text-gray-500 dark:text-gray-400 uppercase">‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏</p>
                                <p className={`text-2xl font-extrabold ${currentStatus.color}`}>{currentStatus.label}</p>
                            </div>
                        </div>
                        <hr className="border-gray-200 dark:border-gray-700 my-4" />
                        <div className="grid grid-cols-2 gap-4">
                            <StatCard 
                                title="‡¶Ü‡¶ú‡¶ï‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡¶æ‡¶°‡¶ø ‡¶ü‡¶æ‡¶á‡¶Æ" 
                                value={formatMinutes(statusData.minutesToday)} 
                                icon="‚è∞"
                                iconColor="text-pink-500"
                            />
                            <StatCard 
                                title="‡¶´‡ßã‡¶ï‡¶æ‡¶∏ ‡¶™‡¶Ø‡¶º‡ßá‡¶®‡ßç‡¶ü" 
                                value={statusData.points} 
                                icon="‚≠êÔ∏è"
                                iconColor="text-yellow-500"
                            />
                        </div>
                    </div>
                    
                    {/* Remote Commands */}
                    <h2 className="text-xl font-bold text-gray-800 dark:text-white mb-4">‡¶∞‡¶ø‡¶Æ‡ßã‡¶ü ‡¶ï‡¶Æ‡¶æ‡¶®‡ßç‡¶°‡¶∏</h2>

                    <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <CommandButton
                            label={statusData.silentMode ? '‡¶∏‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶ö‡¶æ‡¶≤‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®' : '‡¶∏‡¶æ‡¶á‡¶≤‡ßá‡¶®‡ßç‡¶ü ‡¶Æ‡ßã‡¶°'}
                            icon={statusData.silentMode ? 'üîä' : 'üîá'}
                            onClick={() => handleSendCommand('silent')}
                            bgColor={statusData.silentMode ? 'bg-indigo-600' : 'bg-gray-500'}
                            disabled={bluetoothStatus !== 'Connected'}
                        />
                        <CommandButton
                            label="‡¶Æ‡ßã‡¶ü‡¶ø‡¶≠‡ßá‡¶∂‡¶® ‡¶™‡¶æ‡¶†‡¶æ‡¶®"
                            icon="üì£"
                            onClick={() => handleSendCommand('motivation')}
                            bgColor="bg-green-600"
                            disabled={bluetoothStatus !== 'Connected'}
                        />
                        <CommandButton
                            label="‡¶°‡ßá‡¶ü‡¶æ ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü"
                            icon="üîÑ"
                            onClick={() => handleSendCommand('reset')}
                            bgColor="bg-red-600"
                            disabled={bluetoothStatus !== 'Connected'}
                        />
                            <CommandButton
                            label="‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂"
                            icon="üîÅ"
                            onClick={() => handleSendCommand('status')}
                            bgColor="bg-blue-600"
                            disabled={bluetoothStatus !== 'Connected'}
                        />
                    </div>

                    {/* Debug/Info Section */}
                    <h2 className="text-xl font-bold text-gray-800 dark:text-white mt-8 mb-4">‡¶°‡¶ø‡¶¨‡¶æ‡¶ó ‡¶≤‡¶ó</h2>
                    <div className="bg-gray-200 dark:bg-gray-800 p-4 rounded-xl text-xs overflow-x-auto text-gray-700 dark:text-gray-300">
                        <pre className="whitespace-pre-wrap break-words">{statusData.raw}</pre>
                    </div>

                    {/* Custom Modal for Alerts */}
                    <CustomModal 
                        isOpen={isModalOpen}
                        title={modalContent.title}
                        message={modalContent.message}
                        onClose={() => setIsModalOpen(false)}
                        onConfirm={modalContent.onConfirm}
                    />
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
